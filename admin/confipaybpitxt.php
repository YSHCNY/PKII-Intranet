<?php require("db1.php");include("clsmcrypt.php");// $dbh = mysql_connect("localhost", "root", "sysad") or die("Connection Error");// mysql_select_db("maindb", $dbh) or die("Database Error");$loginid = (isset($_GET['loginid'])) ? $_GET['loginid'] :'';$groupname = (isset($_POST['groupname'])) ? $_POST['groupname'] :'';$cutstart = (isset($_POST['cutstart'])) ? $_POST['cutstart'] :'';$cutend = (isset($_POST['cutend'])) ? $_POST['cutend'] :'';$companycode = (isset($_POST['companycode'])) ? $_POST['companycode'] :'';$batchnumber = (isset($_POST['batchnumber'])) ? $_POST['batchnumber'] :'';$payrolldate = (isset($_POST['payrolldate'])) ? $_POST['payrolldate'] :'';$cutoffarray = split("-", $payrolldate);if ( ! isset($cutoffarray[0])) { $cutoffarray[0] = null; }$year = $cutoffarray[0];if ( ! isset($cutoffarray[1])) { $cutoffarray[1] = null; }$month = $cutoffarray[1];if ( ! isset($cutoffarray[2])) { $cutoffarray[2] = null; }$day = $cutoffarray[2];$found = 0;if($loginid != ""){	include("logincheck.php");}if ($found == 1){	header("Content-Type: application-download");	header("Content-Disposition: attachment; filename=$companycode-$batchnumber-$payrolldate.txt ");	$resquery = "SELECT * FROM tblbpipayrollfileresult WHERE groupname=\"$groupname\" AND cutstart=\"$cutstart\" AND cutend=\"$cutend\"";	$result = $dbh2->query($resquery);	if($result->num_rows>0) {		while ($myrow = $result->fetch_assoc()) {		$found = 1;		$bpipayrollfileresultid = $myrow['bpipayrollfileresultid'];		$groupname = $myrow['groupname'];		$cutstart = $myrow['cutstart'];		$cutend = $myrow['cutend'];		$payrolldate = $myrow['payrolldate'];		$batchnumber = $myrow['batchnumber'];		$companycode = $myrow['companycode'];		$compacctnumber = $myrow['compacctnumber'];		$ceilingamount = $myrow['ceilingamount'];		$totalnetpay = $myrow['totalnetpay'];		$acctnumhashtot = $myrow['acctnumhashtot'];		$transactamthashtot = $myrow['transactamthashtot'];		$grandhorizhashtot = $myrow['grandhorizhashtot'];		$recordcount = $myrow['recordcount']; 		}	}	$res2query = "SELECT * FROM tblbpipayrollfilespec WHERE bpipayrollfilespecid=1";	$result2 = $dbh2->query($res2query);	if($result2->num_rows>0) {		while ($myrow2 = $result2->fetch_assoc()) {		$found2 = 1;		$bpipayrollfilespecid = $myrow2['bpipayrollfilespecid'];		$headerrecid = $myrow2['headerrecid'];		$batchnumber = $myrow2['batchnumber'];		$companycode = $myrow2['companycode'];		$headerrectype = $myrow2['headerrectype'];		$compacctnumber = $myrow2['compacctnumber'];		$presofficecode = $myrow2['presofficecode'];		$payrollidentifier = $myrow2['payrollidentifier'];		$detailrecid = $myrow2['detailrecid'];		$detailrectype = $myrow2['detailrectype'];		$trailerrecid = $myrow2['trailerrecid'];		$trailerrectype = $myrow2['trailerrectype'];		}	}//	echo "<pre>";//	echo "$groupname $cutstart $cutend" . "\r\n";// start header record	echo "$headerrecid";	print str_pad($companycode, 5, "0", STR_PAD_LEFT);	print str_pad($month, 2, "0", STR_PAD_LEFT);	print str_pad($day, 2, "0", STR_PAD_LEFT);	print substr($year, 2, 2);	echo "$batchnumber" . "$headerrectype";	print str_pad($compacctnumber, 10, "0", STR_PAD_LEFT);	print str_pad($presofficecode, 3, "0", STR_PAD_LEFT);	$ceilingamount1 = number_format($ceilingamount, 2, '', '');	print str_pad($ceilingamount1, 12, "0", STR_PAD_LEFT);	$totalnetpay1 = number_format($totalnetpay, 2, '', '');	print str_pad($totalnetpay1, 12, "0", STR_PAD_LEFT);	echo "$payrollidentifier";	for ($i = 0; $i < 75; $i++)	{		echo " ";	}	$lnbrkhex = hex2bin("0D0A");	echo $lnbrkhex;	// echo "\r\n";	// echo PHP_EOL;// end header record// start detail record	$res3query = "SELECT tblconfipayroll.employeeid, tblconfipayroll.accesslevel, tblconfipaymeminfo.empalias FROM tblconfipayroll LEFT JOIN tblconfipaymeminfo ON tblconfipayroll.employeeid=tblconfipaymeminfo.employeeid WHERE tblconfipayroll.groupname=\"$groupname\" AND tblconfipaymeminfo.groupname=\"$groupname\" AND tblconfipayroll.cutstart=\"$cutstart\" AND tblconfipayroll.cutend=\"$cutend\"";	$result3 = $dbh2->query($res3query);	if($result3->num_rows>0) {		while ($myrow3 = $result3->fetch_assoc()) {		$found3 = 1;		$employeeid = $myrow3['employeeid'];		$confiaccesslevel = $myrow3['accesslevel'];		$empalias = $myrow3['empalias'];		if($confiaccesslevel==5 && $accesslevel==5) {		include("mcryptdec.php");		$empID = $employeeid;		include("mcryptenc.php");		} else if($confiaccesslevel<=4) {		$empID = $employeeid;		}		// $res4query = "SELECT employeeid, bank_name, acct_num, acct_type FROM tblbankacct WHERE employeeid=\"$empID\" AND bank_name LIKE \"%BPI%\" AND (((bank_branch LIKE \"%Ayala%\" OR bank_branch='') OR (acct_type=\"Current\" OR acct_type=\"Savings\")) OR payrolldflt=1) ORDER BY bankacctid ASC LIMIT 1";		$res4query="SELECT employeeid, bank_name, acct_num, acct_type FROM tblbankacct WHERE employeeid=\"$empID\" AND payrolldflt=1 AND bank_name LIKE \"%BPI%\" LIMIT 1";		$result4 = $dbh2->query($res4query);		if($result4->num_rows>0) {			while ($myrow4 = $result4->fetch_assoc()) {			$found4 = 1;			$bank_name = $myrow4['bank_name'];			$acct_num = str_replace("-", "", $myrow4['acct_num']);			$acct_num = str_replace(" ", "", $acct_num);			$acct_type = $myrow4['acct_type'];			$res5query = "SELECT netpay FROM tblconfipayroll WHERE employeeid=\"$employeeid\" AND groupname=\"$groupname\" AND cutstart=\"$cutstart\" AND cutend=\"$cutend\"";			$result5 = $dbh2->query($res5query);			if($result5->num_rows>0) {				while ($myrow5 = $result5->fetch_assoc()) {				$found5 = 1;				$netpay = $myrow5['netpay'];			include("bpihashfnc.php");				// echo "$acctnum4th.$acctnum4thfin.$acctnumpre1.";				echo "$detailrecid";				print str_pad($companycode, 5, "0", STR_PAD_LEFT);				print str_pad($month, 2, "0", STR_PAD_LEFT);				print str_pad($day, 2, "0", STR_PAD_LEFT);				print substr($year, 2, 2);				echo "$batchnumber" . "$detailrectype";				print str_pad($acctnumfin, 10, "0", STR_PAD_LEFT);				$netpay1 = number_format($netpay, 2, '', '');				print str_pad($netpay1, 12, "0", STR_PAD_LEFT);				$tothhnetpay1 = number_format($tothhnetpay, 2, '', '');				print str_pad($tothhnetpay1, 12, "0", STR_PAD_LEFT);				for ($i = 0; $i < 79; $i++) {					echo " ";				}				$lnbrkhex = hex2bin("0D0A");				echo $lnbrkhex;				// echo "\r\n";				// echo PHP_EOL;				// reset variables				$tothhnetpay=0; $netpay1=0; $tothh56=0; $tothh78=0; $tothh910=0;			} // while ($myrow5 = mysql_fetch_row($result5))		} // if($result5->num_rows>0)			// reset variables			$bank_name=""; $acct_num="";			} // while ($myrow4 = mysql_fetch_row($result4))		} // if($result4 != "")		} // while ($myrow3 = mysql_fetch_row($result3))	} // if($result3 != "")// end detail record// start trailer record	echo "$trailerrecid";	print str_pad($companycode, 5, "0", STR_PAD_LEFT);	print str_pad($month, 2, "0", STR_PAD_LEFT);	print str_pad($day, 2, "0", STR_PAD_LEFT);	print substr($year, 2, 2);	echo "$batchnumber" . "$trailerrectype";	print str_pad($compacctnumber, 10, "0", STR_PAD_LEFT);	print str_pad($acctnumhashtot, 15, "0", STR_PAD_LEFT);	$transactamthashtot1 = number_format($transactamthashtot, 2, '', '');	print str_pad($transactamthashtot1, 15, "0", STR_PAD_LEFT);	$grandhorizhashtot1 = number_format($grandhorizhashtot, 2, '', '');	print str_pad($grandhorizhashtot1, 18, "0", STR_PAD_LEFT);	print str_pad($recordcount, 5, "0", STR_PAD_LEFT);	for ($i = 0; $i < 50; $i++)	{		echo " ";	}	$lnbrkhexfin = hex2bin("0D0A1A");	echo $lnbrkhexfin;	// echo "\r\n";	// echo PHP_EOL;// end trailer record//	echo "</pre>";//     echo "<p><a href=confipay2.php?loginid=$loginid>Back</a><br>";}else{	include("logindeny.php");}// mysql_close($dbh);$dbh2->close();?> 