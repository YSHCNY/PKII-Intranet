<?php require("db1.php");include("clsmcrypt.php");$loginid = (isset($_GET['loginid'])) ? $_GET['loginid'] :'';$groupname = (isset($_POST['groupname'])) ? $_POST['groupname'] :'';$companycode = (isset($_POST['companycode'])) ? $_POST['companycode'] :'';$batchnumber = (isset($_POST['batchnumber'])) ? $_POST['batchnumber'] :'';$payrolldate = (isset($_POST['payrolldate'])) ? $_POST['payrolldate'] :'';$cutoffarray = split("-", $payrolldate);if ( ! isset($cutoffarray[0])) { $cutoffarray[0] = null; }$year = $cutoffarray[0];if ( ! isset($cutoffarray[1])) { $cutoffarray[1] = null; }$month = $cutoffarray[1];if ( ! isset($cutoffarray[2])) { $cutoffarray[2] = null; }$day = $cutoffarray[2];$found = 0;if($loginid != ""){	include("logincheck.php");}if ($found == 1){	header("Content-Type: application-download");	header("Content-Disposition: attachment; filename=$companycode-$batchnumber-$payrolldate.txt ");	$resquery = "SELECT * FROM tblbpipayrollfileresult WHERE groupname=\"$groupname\" AND payrolldate=\"$payrolldate\"";	$result = $dbh2->query($resquery);	if($result->num_rows>0) {		while($myrow = $result->fetch_assoc()) {		$found = 1;		$bpipayrollfileresultid = $myrow['bpipayrollfileresultid'];		$groupname = $myrow['groupname'];		$cutstart = $myrow['cutstart'];		$cutend = $myrow['cutend'];		$payrolldate = $myrow['payrolldate'];		$batchnumber = $myrow['batchnumber'];		$companycode = $myrow['companycode'];		$compacctnumber = $myrow['compacctnumber'];		$ceilingamount = $myrow['ceilingamount'];		$totalnetpay = $myrow['totalnetpay'];		$acctnumhashtot = $myrow['acctnumhashtot'];		$transactamthashtot = $myrow['transactamthashtot'];		$grandhorizhashtot = $myrow['grandhorizhashtot'];		$recordcount = $myrow['recordcount']; 		}	}	$res2query = "SELECT * FROM tblbpipayrollfilespec WHERE bpipayrollfilespecid=1";	$result2 = $dbh2->query($res2query);	if($result2->num_rows>0) {		while ($myrow2 = $result2->fetch_assoc()) {		$found2 = 1;		$bpipayrollfilespecid = $myrow2['bpipayrollfilespecid'];		$headerrecid = $myrow2['headerrecid'];		$batchnumber = $myrow2['batchnumber'];		$companycode = $myrow2['companycode'];		$headerrectype = $myrow2['headerrectype'];		$compacctnumber = $myrow2['compacctnumber'];		$presofficecode = $myrow2['presofficecode'];		$payrollidentifier = $myrow2['payrollidentifier'];		$detailrecid = $myrow2['detailrecid'];		$detailrectype = $myrow2['detailrectype'];		$trailerrecid = $myrow2['trailerrecid'];		$trailerrectype = $myrow2['trailerrectype'];		}	}//	echo "<pre>";// start header record	echo "$headerrecid";	print str_pad($companycode, 5, "0", STR_PAD_LEFT);	print str_pad($month, 2, "0", STR_PAD_LEFT);	print str_pad($day, 2, "0", STR_PAD_LEFT);	print substr($year, 2, 2);	echo "$batchnumber" . "$headerrectype";	print str_pad($compacctnumber, 10, "0", STR_PAD_LEFT);	print str_pad($presofficecode, 3, "0", STR_PAD_LEFT);	$ceilingamount1 = number_format($ceilingamount, 2, '', '');	print str_pad($ceilingamount1, 12, "0", STR_PAD_LEFT);	$totalnetpay1 = number_format($totalnetpay, 2, '', '');	print str_pad($totalnetpay1, 12, "0", STR_PAD_LEFT);	echo "$payrollidentifier";	for ($i = 0; $i < 75; $i++)	{		echo " ";	}	$lnbrkhex = hex2bin("0D0A");	echo $lnbrkhex;	// echo "\r\n";	// echo PHP_EOL;// end header record// start detail record	$res3query = "SELECT employeeid FROM tblemppaybonus WHERE groupname=\"$groupname\" ORDER BY employeeid ASC";	$result3 = $dbh2->query($res3query);	if($result3->num_rows>0) {		while($myrow3 = $result3->fetch_assoc()) {		$found3 = 1;		$employeeid = $myrow3['employeeid'];		// $groupname = $myrow3[1];		// $cutstart = $myrow3[2];		// $cutend = $myrow3[3];		// $confiaccesslevel = $myrow3[4];		// $empalias = $myrow3[5];		/*		if($confiaccesslevel==5 && $accesslevel==5) {		include("mcryptdec.php");		$empID = $employeeid;		include("mcryptenc.php");		} else if($confiaccesslevel<=4) {		$empID = $employeeid;		}		*/		$empID = $employeeid;		// echo "$empID";		// $res4query = "SELECT employeeid, bank_name, acct_num, acct_type FROM tblbankacct WHERE employeeid=\"$employeeid\" AND bank_name LIKE \"%BPI%\" AND (((bank_branch LIKE \"%Ayala%\" OR bank_branch='') OR (acct_type=\"Current\" OR acct_type=\"Savings\")) OR payrolldflt=1) ORDER BY bankacctid ASC LIMIT 1";		$res4query = "SELECT employeeid, bank_name, acct_num, acct_type FROM tblbankacct WHERE employeeid=\"$employeeid\" AND payrolldflt=1";		$result4 = $dbh2->query($res4query);		if($result4->num_rows>0) {			while ($myrow4 = $result4->fetch_assoc()) {			$found4 = 1;			$bank_name = $myrow4['bank_name'];			$acct_num = str_replace("-", "", $myrow4['acct_num']);			$acct_num = str_replace(" ", "", $acct_num);			$acct_type = $myrow4['acct_type'];			// echo "$bank_name:$acct_num";			$res5query = "SELECT netamt FROM tblemppaybonus WHERE employeeid=\"$employeeid\" AND groupname=\"$groupname\"";			$result5 = $dbh2->query($res5query);			if($result5->num_rows>0) {				while($myrow5 = $result5->fetch_assoc()) {				$found5 = 1;				$netamt = $myrow5['netamt'];				$tothh56 = 0;				$tothh78 = 0;				$tothh910 = 0;				$tothhnetpay = 0;				$netpay = $netamt;				// echo "$netamt";				$counter = $counter + 1;				$acctnum4th = substr($acct_num, 3, 1);				if ($acctnum4th == '5') {					if ($acct_type == 'Savings') {						$acctnum4thfin = '6';					} else {						$acctnum4thfin = $acctnum4th;					}				} else {					$acctnum4thfin = $acctnum4th;				}				$acctnumpre1 = substr($acct_num, 0, 3);				$acctnumpre2 = substr($acct_num, 4, 6);				$acctnumfin = "$acctnumpre1$acctnum4thfin$acctnumpre2";				// echo "$acctnumfin.";				$acct_num04 = substr($acctnumfin, 0, 4);				$hh56 = substr($acctnumfin, 4, 2);				$hh78 = substr($acctnumfin, 6, 2);				$hh910 = substr($acctnumfin, 8, 2);				$tothh56 = $hh56 * $netpay;				$tothh78 = $hh78 * $netpay;				$tothh910 = $hh910 * $netpay;				$tothhnetpay = $tothh56 + $tothh78 + $tothh910;				// echo "$acctnum4th.$acctnum4thfin.$acctnumpre1.";				// echo "$tothhnetpay.";				echo "$detailrecid";				print str_pad($companycode, 5, "0", STR_PAD_LEFT);				print str_pad($month, 2, "0", STR_PAD_LEFT);				print str_pad($day, 2, "0", STR_PAD_LEFT);				print substr($year, 2, 2);				echo "$batchnumber" . "$detailrectype";				print str_pad($acctnumfin, 10, "0", STR_PAD_LEFT);				$netpay1 = number_format($netpay, 2, '', '');				print str_pad($netpay1, 12, "0", STR_PAD_LEFT);				$tothhnetpay1 = number_format($tothhnetpay, 2, '', '');				print str_pad($tothhnetpay1, 12, "0", STR_PAD_LEFT);		echo "|$acctnum4th|$acct_type|$acctnum4thfin";				for ($i = 0; $i < 79; $i++) {					echo " ";				}				$lnbrkhex = hex2bin("0D0A");				echo $lnbrkhex;				// echo "\r\n";				// echo PHP_EOL;				// reset variables				$tothhnetpay=0; $netpay1=0; $tothh56=0; $tothh78=0; $tothh910=0;				} // while ($myrow5 = mysql_fetch_row($result5))			} // if($result5			// reset variables			$bank_name=""; $acct_num="";			} // while ($myrow4 = mysql_fetch_row($result4))		} // if($result4 != "")		} // while ($myrow3 = mysql_fetch_row($result3))	} // if($result3 != "")// end detail record// start trailer record	echo "$trailerrecid";	print str_pad($companycode, 5, "0", STR_PAD_LEFT);	print str_pad($month, 2, "0", STR_PAD_LEFT);	print str_pad($day, 2, "0", STR_PAD_LEFT);	print substr($year, 2, 2);	echo "$batchnumber" . "$trailerrectype";	print str_pad($compacctnumber, 10, "0", STR_PAD_LEFT);	print str_pad($acctnumhashtot, 15, "0", STR_PAD_LEFT);	$transactamthashtot1 = number_format($transactamthashtot, 2, '', '');	print str_pad($transactamthashtot1, 15, "0", STR_PAD_LEFT);	$grandhorizhashtot1 = number_format($grandhorizhashtot, 2, '', '');	print str_pad($grandhorizhashtot1, 18, "0", STR_PAD_LEFT);	print str_pad($recordcount, 5, "0", STR_PAD_LEFT);	for ($i = 0; $i < 50; $i++)	{		echo " ";	}	$lnbrkhexfin = hex2bin("0D0A1A");	echo $lnbrkhexfin;	// echo "\n\r";	// echo PHP_EOL;// end trailer record//	echo "</pre>";//     echo "<p><a href=confipay2.php?loginid=$loginid>Back</a><br>";}else{	include("logindeny.php");}// mysql_close($dbh);$dbh2->close();?> 