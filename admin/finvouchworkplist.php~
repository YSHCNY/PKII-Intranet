<?php 

include("db1.php");
include("datetimenow.php");

$loginid = (isset($_GET['loginid'])) ? $_GET['loginid'] :'';
$username = (isset($_POST['username'])) ? $_POST['username'] :'';
$password = (isset($_POST['password'])) ? $_POST['password'] :'';

$yrmonthavlbl = (isset($_POST['yrmonthavlbl'])) ? $_POST['yrmonthavlbl'] :'';

if($yrmonthavlbl == '') {
  $selyear = $yearnow;
  $selmonth = date("F", mktime(0, 0, 0, $monthnow));
  $yrmonthavlbl = $selyear." ".$selmonth;
}

$found = 0;

if($loginid != "") {
     include("logincheck.php");
}  

if ($found == 1) {
     include ("header.php");
     include ("sidebar.php");

// start contents here

echo "<table class=\"fin\" border=\"1\">";
echo "<tr><td colspan=\"4\">";
?>
<script type="text/javascript" src="js/jquery-1.4.4.min.js"></script>
<script type="text/javascript">
  $(function() {
    $("#exportToExcel").click(function() {
      var data='<table>' + $("#ReportTable").html().replace(/<a\/?[^>]+>/gi,'')+'</table>';
      $('body').prepend("<form method='post' action='exportexcel.php' style='display:none' id='ReportTableData'><input type='text' name='tableData' value='"+data+"'></form>");
      $('#ReportTableData').submit().remove();
  });
});
</script>
<?php
  echo "<table id=\"ReportTable\" class=\"fin\" border=\"1\">";

  echo "<tr><td colspan=\"18\" align=\"center\">";
    echo "<form action=\"finvouchworkplist.php?loginid=$loginid\" method=\"post\" target=\"_self\">";
    echo "<select name=\"yrmonthavlbl\">";
    echo "<option>Year-Month</option>";

    $result11 = mysql_query("SELECT DISTINCT DATE_FORMAT(month, '%Y %M') as yyyymonth FROM tblfinworkpaper WHERE workpaperid <> '' ORDER BY month DESC;", $dbh);
    while($myrow11 = mysql_fetch_row($result11)) {
      $found11 = 1;
      $yyyymonth = $myrow11[0];

      if($yrmonthavlbl == "$yyyymonth") { $yrmonthsel = "selected"; }
      else { $yrmonthsel = ""; }

      echo "<option value=\"$yyyymonth\" $yrmonthsel>$yyyymonth</option>";
    } //while
    echo "</select>";

    echo "<input type=\"submit\" value=\"Submit\"></form>";
  echo "</td></tr>";

  echo "<tr><th colspan=\"18\"><a href=\"#\" id=\"exportToExcel\"><img src=\"./images/sheet.gif\"></a>&nbsp;PKII Working Paper</th></tr>";
  echo "<tr><th colspan=\"18\">For the month of $yrmonthavlbl</th></tr>";

  $debitmonthtot = 0; $creditmonthtot = 0;

  echo "<tr><th colspan=\"2\">Account</th><th colspan=\"2\">Beginning Balance</th><th colspan=\"2\">Cash Disbursement</th><th colspan=\"2\">Accounts Payable</th><th colspan=\"2\">Cash Receipt</th><th colspan=\"2\">Journal Book</th><th colspan=\"2\">Trial Balance</th><th colspan=\"2\">Balance Sheet</th><th colspan=\"2\">Income Statement</th></tr>";
  echo "<tr><td align=\"center\">GL Code</td><td align=\"center\">GL Name</td><td align=\"center\">Debit</td><td align=\"center\">Credit</td><td align=\"center\">Debit</td><td align=\"center\">Credit</td><td align=\"center\">Debit</td><td align=\"center\">Credit</td><td align=\"center\">Debit</td><td align=\"center\">Credit</td><td align=\"center\">Debit</td><td align=\"center\">Credit</td><td align=\"center\">Debit</td><td align=\"center\">Credit</td><td align=\"center\">Debit</td><td align=\"center\">Credit</td><td align=\"center\">Debit</td><td align=\"center\">Credit</td></tr>";

    $res11query=""; $result11=""; $found11=0; $ctr11=0;
  $res11query="SELECT DISTINCT workpaperid, month, glcode, glrefver, begbalancedr, begbalancecr, cashdisbursementdr, cashdisbursementcr, cashreceiptdr, cashreceiptcr, journaldr, journalcr, trialbalancedr, trialbalancecr, balancesheetdr, balancesheetcr, incomestatementdr, incomestatementcr, acctpayabledr, acctpayablecr FROM tblfinworkpaper WHERE workpaperid<>'' AND DATE_FORMAT(month, '%Y %M') = \"$yrmonthavlbl\" ORDER BY workpaperid ASC";
    $result11=$dbh2->query($res11query);
    if($result11->num_rows>0) {
        while($myrow11=$result11->fetch_assoc()) {
    $found11 = 1;
    $ctr11++;
    $workpaperid11 = $myrow11['workpaperid'];
    $month11 = $myrow11['month'];
    $glcode11 = $myrow11['glcode'];
    $glrefver11 = $myrow11['glrefver'];
    $begbalancedr11 = $myrow11['begbalancedr'];
    $begbalancecr11 = $myrow11['begbalancecr'];
    $cashdisbursementdr11 = $myrow11['cashdisbursementdr'];
    $cashdisbursementcr11 = $myrow11['cashdisbursementcr'];
    $cashreceiptdr11 = $myrow11['cashreceiptdr'];
    $cashreceiptcr11 = $myrow11['cashreceiptcr'];
    $journaldr11 = $myrow11['journaldr'];
    $journalcr11 = $myrow11['journalcr'];
    $trialbalancedr11 = $myrow11['trialbalancedr'];
    $trialbalancecr11 = $myrow11['trialbalancecr'];
    $balancesheetdr11 = $myrow11['balancesheetdr'];
    $balancesheetcr11 = $myrow11['balancesheetcr'];
    $incomestatementdr11 = $myrow11['incomestatementdr'];
    $incomestatementcr11 = $myrow11['incomestatementcr'];
    $acctpayabledr11 = $myrow11['acctpayabledr'];
    $acctpayablecr11 = $myrow11['acctpayablecr'];

    $count1 = $count1 + 1;

    echo "<tr><td>$glcode11</td>";
/*
    $result12 = mysql_query("SELECT glname FROM tblfinglref WHERE glcode=\"$glcode11\" AND version=\"$glrefver11\"", $dbh);
    if($result12 != '') {
      while($myrow12 = mysql_fetch_row($result12)) {
  $found12 = 1;
  $glname12 = $myrow12[0];
      } //while
    } //if
*/
// 20220725 new query fr tblfinglref to tblfinworkpaperref for acct name
    $res12query=""; $result12=""; $found12=0;
    $res12query="SELECT wpacctname FROM tblfinworkpaperref WHERE glcode=\"$glcode11\" AND glrefver=2";
    $result12=$dbh2->query($res12query);
    if($result12->num_rows>0) {
        while($myrow12=$result12->fetch_assoc()) {
        $found12=1;
        $wpacctname12 = $myrow12['wpacctname'];
        } //while
    } //if

//    echo "<td>$glname12</td>";
    echo "<td>$wpacctname12</td>";
    echo "<td align=\"right\">".number_format($begbalancedr11,2)."</td><td align=\"right\">".number_format($begbalancecr11,2)."</td><td align=\"right\">".number_format($cashdisbursementdr11,2)."</td><td align=\"right\">".number_format($cashdisbursementcr11,2)."</td>";
    echo "<td align=\"right\">".number_format($acctpayabledr11,2)."</td><td align=\"right\">".number_format($acctpayablecr11,2)."</td>";
    echo "<td align=\"right\">".number_format($cashreceiptdr11,2)."</td><td align=\"right\">".number_format($cashreceiptcr11,2)."</td><td align=\"right\">".number_format($journaldr11,2)."</td><td align=\"right\">".number_format($journalcr11,2)."</td><td align=\"right\">".number_format($trialbalancedr11,2)."</td><td align=\"right\">".number_format($trialbalancecr11,2)."</td><td align=\"right\">".number_format($balancesheetdr11,2)."</td><td align=\"right\">".number_format($balancesheetcr11,2)."</td><td align=\"right\">".number_format($incomestatementdr11,2)."</td><td align=\"right\">".number_format($incomestatementcr11,2)."</td></tr>";
        } //while

    $res14query=""; $result14=""; $found14=0; $ctr14=0;
  $res14query="SELECT workpapertotid, begbalancedr, begbalancecr, cashdisbursementdr, cashdisbursementcr, cashreceiptdr, cashreceiptcr, journaldr, journalcr, trialbalancedr, trialbalancecr, balancesheetdr, balancesheetcr, incomestatementdr, incomestatementcr, balancesheetdrdiff, balancesheetcrdiff, incomestatementdrdiff, incomestatementcrdiff, balancesheetdrgrandtot, balancesheetcrgrandtot, incomestatementdrgrandtot, incomestatementcrgrandtot, status, remarks, acctpayabledrtot, acctpayablecrtot FROM tblfinworkpapertot WHERE DATE_FORMAT(month, '%Y %M') = \"$yrmonthavlbl\"";
    $result14=$dbh2->query($res14query);
    if($result14->num_rows>0) {
        while($myrow14=$result14->fetch_assoc()) {
    $found14 = 1;
    $workpapertotid = $myrow14['workpapertotid'];
    $begbalancedrtot = $myrow14['begbalancedr'];
    $begbalancecrtot = $myrow14['begbalancecr'];
    $cashdisbursementdrtot = $myrow14['cashdisbursementdr'];
    $cashdisbursementcrtot = $myrow14['cashdisbursementcr'];
    $cashreceiptdrtot = $myrow14['cashreceiptdr'];
    $cashreceiptcrtot = $myrow14['cashreceiptcr'];
    $journaldrtot = $myrow14['journaldr'];
    $journalcrtot = $myrow14['journalcr'];
    $trialbalancedrtot = $myrow14['trialbalancedr'];
    $trialbalancecrtot = $myrow14['trialbalancecr'];
    $balancesheetdrtot = $myrow14['balancesheetdr'];
    $balancesheetcrtot = $myrow14['balancesheetcr'];
    $incomestatementdrtot = $myrow14['incomestatementdr'];
    $incomestatementcrtot = $myrow14['incomestatementcr'];
    $balancesheetdrdiff = $myrow14['balancesheetdrdiff'];
    $balancesheetcrdiff = $myrow14['balancesheetcrdiff'];
    $incomestatementdrdiff = $myrow14['incomestatementdrdiff'];
    $incomestatementcrdiff = $myrow14['incomestatementcrdiff'];
    $balancesheetdrgrandtot = $myrow14['balancesheetdrgrandtot'];
    $balancesheetcrgrandtot = $myrow14['balancesheetcrgrandtot'];
    $incomestatementdrgrandtot = $myrow14['incomestatementdrgrandtot'];
    $incomestatementcrgrandtot = $myrow14['incomestatementcrgrandtot'];
    $status14 = $myrow14['status'];
    $remarks14 = $myrow14['remarks'];
    $acctpayabledrtot = $myrow14['acctpayabledrtot'];
    $acctpayablecrtot = $myrow14['acctpayablecrtot'];
        } //while
    } //if

  echo "<tr>
  <th colspan=\"2\" align=\"right\">Total|f14:$found14,id:$workpapertotid</th>
  <th align=\"right\">".number_format($begbalancedrtot,2)."</th>
  <th align=\"right\">".number_format($begbalancecrtot,2)."</th>
  <th align=\"right\">".number_format($cashdisbursementdrtot,2)."</th>
  <th align=\"right\">".number_format($cashdisbursementcrtot,2)."</th>
  <th align=\"right\">".number_format($acctpayabledrtot,2)."</th>
  <th align=\"right\">".number_format($acctpayablecrtot,2)."</th>
  <th align=\"right\">".number_format($cashreceiptdrtot,2)."</th>
  <th align=\"right\">".number_format($cashreceiptcrtot,2)."</th>
  <th align=\"right\">".number_format($journaldrtot,2)."</th>
  <th align=\"right\">".number_format($journalcrtot,2)."</th>
  <th align=\"right\">".number_format($trialbalancedrtot,2)."</th>
  <th align=\"right\">".number_format($trialbalancecrtot,2)."</th>
    <td align=\"right\">".number_format($balancesheetdrtot,2)."</td>
    <td align=\"right\">".number_format($balancesheetcrtot,2)."</td>
    <td align=\"right\">".number_format($incomestatementdrtot,2)."</td>
    <td align=\"right\">".number_format($incomestatementcrtot,2)."</td></tr>";

  echo "<tr><td colspan=\"14\">&nbsp;</td>
  <th align=\"right\">".number_format($balancesheetcrdiff,2)."</th>
  <th align=\"right\">".number_format($balancesheetdrdiff,2)."</th>
  <th align=\"right\">".number_format($incomestatementcrdiff,2)."</th>
  <th>".number_format($incomestatementdrdiff,2)."</th></tr>";

  echo "<tr><td colspan=\"14\"></td>
  <th align=\"right\">".number_format($balancesheetdrtot - $balancesheetcrdiff,2)."</th>
  <th align=\"right\">".number_format($balancesheetcrtot + $balancesheetdrdiff,2)."</th>
  <th align=\"right\">".number_format($incomestatementdrtot + $incomestatementcrdiff,2)."</th>
  <th align=\"right\">".number_format($incomestatementcrtot - $incomestatementdrdiff ,2)."</th></tr>";
    } //if

  echo "</table>";
?>

</td></tr>

<?php
echo "</table>";

echo "<br><p><a href=\"finvouchmain.php?loginid=$loginid\" class='btn btn-default' role='button'>Back</a></p>";



// end contents here

     $resquery="UPDATE tbladminlogin SET adminloginstat=1 WHERE adminuid='$username'";
    $result=$dbh2->query($resquery); 

     include ("footer.php");
} else {
     include ("logindeny.php");
}

mysql_close($dbh);
$dbh2->close();
?>
